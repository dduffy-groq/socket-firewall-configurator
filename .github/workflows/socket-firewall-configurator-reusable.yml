# Socket Firewall Configurator - Reusable Workflow (Free Tier)
#
# Generates socket.yml configurations from centralized policy definitions.
# Works without API keys - uses policy-based validation.

name: Socket Firewall Configurator (Reusable)

on:
  workflow_call:
    inputs:
      repository:
        description: 'Specific repository to generate config for (optional)'
        required: false
        type: string
      validate_only:
        description: 'Only validate policies without generating output'
        required: false
        default: false
        type: boolean
      python_version:
        description: 'Python version to use'
        required: false
        default: '3.11'
        type: string
    # Secrets are optional for free tier
    secrets:
      GITHUB_APP_ID:
        required: false
        description: 'GitHub App ID (optional - for PR creation)'
      GITHUB_APP_PRIVATE_KEY:
        required: false
        description: 'GitHub App private key (optional - for PR creation)'

permissions:
  contents: read

jobs:
  generate-config:
    name: Generate Socket Configuration
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Configurator Repository
        uses: actions/checkout@v4
        with:
          repository: dduffy-groq/socket-firewall-configurator
          path: configurator
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}
          cache: 'pip'
          cache-dependency-path: configurator/requirements.txt
      
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r configurator/requirements.txt
      
      - name: Validate Policies
        working-directory: configurator
        run: |
          python -m socket_firewall_configurator.configurator \
            --policy-dir policies/ \
            --validate-only \
            --verbose
      
      - name: Generate Socket Configurations
        if: ${{ !inputs.validate_only }}
        id: generate
        working-directory: configurator
        run: |
          ARGS="--policy-dir policies/ --output-dir output/"
          
          if [ -n "${{ inputs.repository }}" ]; then
            ARGS="$ARGS --repo ${{ inputs.repository }}"
          fi
          
          python -m socket_firewall_configurator.configurator $ARGS --verbose
          
          # List generated files
          echo "Generated configurations:"
          find output/ -name "socket.yml" -type f || echo "No files generated"
      
      - name: Display Generated Configs
        if: ${{ !inputs.validate_only }}
        working-directory: configurator
        run: |
          echo "=== Generated socket.yml files ==="
          for f in output/*/socket.yml; do
            if [ -f "$f" ]; then
              echo ""
              echo "--- $f ---"
              cat "$f"
            fi
          done
      
      - name: Upload Configurations
        if: ${{ !inputs.validate_only }}
        uses: actions/upload-artifact@v4
        with:
          name: socket-configurations
          path: configurator/output/
          retention-days: 7
