# Socket Security - Reusable Workflow
#
# Provides centralized Socket security scanning for all repositories.
# Uses npm audit + sfw for free tier, or SocketDev action with API key.

name: Socket Security (Reusable)

on:
  workflow_call:
    inputs:
      enable_comments:
        description: 'Enable PR comments for security issues'
        required: false
        default: true
        type: boolean
      fail_on_error:
        description: 'Fail workflow if security issues found'
        required: false
        default: true
        type: boolean
    secrets:
      SOCKET_SECURITY_API_KEY:
        required: false
        description: 'Socket API key (optional for free tier basic scanning)'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  socket-security:
    name: Socket Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Display socket.yml (if exists)
        run: |
          if [ -f "socket.yml" ]; then
            echo "=== socket.yml ==="
            cat socket.yml
          else
            echo "No socket.yml found - using default configuration"
          fi
      
      - name: Install Socket Firewall
        run: npm install -g sfw
      
      - name: Clear npm cache
        run: npm cache clean --force
      
      - name: Create package-lock.json
        run: npm install --package-lock-only --ignore-scripts 2>/dev/null || true
      
      - name: Socket Firewall Scan
        id: sfw-scan
        run: |
          echo "=== Socket Firewall Scan ==="
          echo ""
          
          # Run sfw to check dependencies
          sfw npm install --dry-run 2>&1 | tee sfw-output.txt || true
          
          echo ""
          echo "=== sfw complete ==="
      
      - name: npm audit (CVE detection)
        id: npm-audit
        run: |
          echo "=== npm audit ==="
          npm audit 2>&1 | tee audit-output.txt
          AUDIT_EXIT=${PIPESTATUS[0]}
          
          echo ""
          echo "Audit exit code: $AUDIT_EXIT"
          
          if [ $AUDIT_EXIT -ne 0 ]; then
            echo ""
            echo "‚ö†Ô∏è npm audit found vulnerabilities"
            echo "audit_failed=true" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ No vulnerabilities found"
            echo "audit_failed=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true
      
      - name: Check for protestware
        id: protestware-check
        run: |
          echo "=== Protestware Check ==="
          VIOLATIONS=0
          
          # Check package.json for known protestware
          if [ -f "package.json" ]; then
            # faker@6.6.6
            if grep -q '"faker"' package.json; then
              VERSION=$(cat package.json | jq -r '.dependencies.faker // .devDependencies.faker // empty')
              if [ "$VERSION" = "6.6.6" ]; then
                echo "‚ùå BLOCKED: faker@6.6.6 (protestware)"
                VIOLATIONS=$((VIOLATIONS + 1))
              fi
            fi
            
            # colors@1.4.x
            if grep -q '"colors"' package.json; then
              VERSION=$(cat package.json | jq -r '.dependencies.colors // .devDependencies.colors // empty')
              if [[ "$VERSION" =~ ^1\.4\.[1-9] ]]; then
                echo "‚ùå BLOCKED: colors@$VERSION (protestware)"
                VIOLATIONS=$((VIOLATIONS + 1))
              fi
            fi
          fi
          
          echo ""
          echo "violations=$VIOLATIONS" >> $GITHUB_OUTPUT
          
          if [ $VIOLATIONS -gt 0 ]; then
            echo "üö´ Found $VIOLATIONS protestware package(s)!"
          else
            echo "‚úÖ No protestware detected"
          fi
      
      - name: Security Summary
        run: |
          echo ""
          echo "=== Security Summary ==="
          echo ""
          echo "Socket Firewall: Scanned"
          echo "npm audit: ${{ steps.npm-audit.outputs.audit_failed == 'true' && 'Vulnerabilities found' || 'Clean' }}"
          echo "Protestware: ${{ steps.protestware-check.outputs.violations }} violations"
      
      - name: Fail on security issues
        if: ${{ inputs.fail_on_error }}
        run: |
          if [ "${{ steps.npm-audit.outputs.audit_failed }}" = "true" ]; then
            echo "‚ùå Failing due to npm audit vulnerabilities"
            exit 1
          fi
          
          if [ "${{ steps.protestware-check.outputs.violations }}" != "0" ]; then
            echo "‚ùå Failing due to protestware detection"
            exit 1
          fi
          
          echo "‚úÖ All security checks passed"
      
      - name: Upload Scan Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: socket-scan-results
          path: |
            sfw-output.txt
            audit-output.txt
          if-no-files-found: ignore
          retention-days: 7
